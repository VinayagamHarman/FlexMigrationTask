/**
 * Generated by Apache Royale Compiler from org/apache/royale/textLayout/operations/CreateSubParagraphGroupOperation.as
 * org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation
 *
 * @fileoverview
 *
 * @suppress {missingRequire|checkTypes|accessControls}
 */

goog.provide('org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation');
/* Royale Dependency List: org.apache.royale.textLayout.edit.ElementMark,org.apache.royale.textLayout.edit.MementoList,org.apache.royale.textLayout.edit.ModelEdit,org.apache.royale.textLayout.edit.SelectionState,org.apache.royale.textLayout.elements.IFlowElement,org.apache.royale.textLayout.elements.IFlowGroupElement,org.apache.royale.textLayout.elements.IParagraphElement,org.apache.royale.textLayout.elements.ISpanElement,org.apache.royale.textLayout.elements.ISubParagraphGroupElementBase,org.apache.royale.textLayout.elements.SubParagraphGroupElement,org.apache.royale.textLayout.formats.ITextLayoutFormat,org.apache.royale.utils.Language,XML*/

goog.require('org.apache.royale.textLayout.operations.FlowTextOperation');



/** 
 * Constructor.
 * 
 * This operation creates a single SubParagraphGroupElement in the first paragraph of the selection range.  That paragraph must have at least one character selected the paragraph terminator does not count towards that selection.
 * Specifying the spgeParent creates an SubParagraphGroupElement int he part of the selection range included by that spgeParent.
 * 
 * @asparam operationState selection over which to apply the operation.  
 * @asparam spgeParent optional parent for the spge element.  If not specified one is chosen based on the selection
 * @asparam spgeFormat optional format to set in the new spge element.
 * 
 * @playerversion Flash 10
 * @playerversion AIR 1.5
 * @langversion 3.0 
 * @constructor
 * @extends {org.apache.royale.textLayout.operations.FlowTextOperation}
 * @param {org.apache.royale.textLayout.edit.SelectionState} operationState
 * @param {org.apache.royale.textLayout.elements.IFlowGroupElement=} parent
 * @param {org.apache.royale.textLayout.formats.ITextLayoutFormat=} format
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation = function(operationState, parent, format) {
  parent = typeof parent !== 'undefined' ? parent : null;
  format = typeof format !== 'undefined' ? format : null;
  org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.base(this, 'constructor', operationState);
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__format = format;
  this.parent = parent;
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList = new org.apache.royale.textLayout.edit.MementoList(operationState.textFlow);
};
goog.inherits(org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation, org.apache.royale.textLayout.operations.FlowTextOperation);


/**
 * Prevent renaming of class. Needed for reflection.
 */
goog.exportSymbol('org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation', org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation);


/**
 * @private
 * @type {org.apache.royale.textLayout.edit.ElementMark}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeParentMarker;


/**
 * @private
 * @type {org.apache.royale.textLayout.formats.ITextLayoutFormat}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__format;


/**
 * @private
 * @type {org.apache.royale.textLayout.edit.MementoList}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList;


/**
 * @private
 * @type {org.apache.royale.textLayout.elements.SubParagraphGroupElement}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement;


/**
 * @private
 * @type {org.apache.royale.textLayout.edit.SelectionState}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__postOpSelectionState;


/**
 *  @asprivate
 * @royaleignorecoercion org.apache.royale.textLayout.elements.IFlowGroupElement
 * @royaleignorecoercion org.apache.royale.textLayout.elements.ISpanElement
 * @export
 * @override
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.doOperation = function() {
  var /** @type {number} */ endChildIndex = 0;
  if (this.absoluteStart == this.absoluteEnd)
    return false;
  var /** @type {Object} */ target = this.parent;
  if (!target)
    return false;
  var /** @type {number} */ begChildIndex = 0;
  var /** @type {number} */ begStart = (this.absoluteStart - target.getAbsoluteStart()) >> 0;
  
  //var /** @type {number} */ endChildIndex = 0;
  var /** @type {number} */ endStart = (this.absoluteEnd - target.getAbsoluteStart()) >> 0;
  if (endStart >= target.getAbsoluteStart() + target.textLength - 1)
    endStart = (target.getAbsoluteStart() + target.textLength) >> 0;
  var /** @type {org.apache.royale.textLayout.elements.IFlowElement} */ child;
  if (begStart > 0) {
    begChildIndex = target.findChildIndexAtPosition(begStart);
    child = target.getChildAt(begChildIndex);
    if (child.parentRelativeStart != begStart) {
      if (org.apache.royale.utils.Language.is(child, org.apache.royale.textLayout.elements.IFlowGroupElement))
        this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList.push(org.apache.royale.textLayout.edit.ModelEdit.splitElement(this.textFlow, child, (begStart - child.parentRelativeStart) >> 0));
      else
        child.splitAtPosition((begStart - child.parentRelativeStart) >> 0);
      begChildIndex++;
    }
  }
  if (endStart >= 0) {
    if (endStart >= target.textLength - 1) {
      endChildIndex = target.numChildren;
      if (endChildIndex != 0) {
        var /** @type {org.apache.royale.textLayout.elements.IFlowElement} */ lastChild = target.getChildAt((endChildIndex - 1) >> 0);
        if (org.apache.royale.utils.Language.is(lastChild, org.apache.royale.textLayout.elements.ISpanElement) && lastChild.textLength == 1 && lastChild.hasParagraphTerminator)
          endChildIndex--;
      }
    } else {
      endChildIndex = target.findChildIndexAtPosition(endStart);
      child = target.getChildAt(endChildIndex);
      if (child.parentRelativeStart != endStart) {
        if (org.apache.royale.utils.Language.is(child, org.apache.royale.textLayout.elements.IFlowGroupElement))
          this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList.push(org.apache.royale.textLayout.edit.ModelEdit.splitElement(this.textFlow, child, (endStart - child.parentRelativeStart) >> 0));
        else
          child.splitAtPosition((endStart - child.parentRelativeStart) >> 0);
        endChildIndex++;
      }
    }
  }
  else
    endChildIndex = (begChildIndex + 1) >> 0;
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement = new org.apache.royale.textLayout.elements.SubParagraphGroupElement();
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement.format = this.format;
  
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList.push(org.apache.royale.textLayout.edit.ModelEdit.addElement(this.textFlow, this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement, target, endChildIndex));
  while (begChildIndex < endChildIndex) {
    child = target.getChildAt(begChildIndex);
    if (child.textLength == 0) {
      begChildIndex++;
    } else {
      this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList.push(org.apache.royale.textLayout.edit.ModelEdit.moveElement(this.textFlow, child, this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement, this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement.numChildren));
      endChildIndex--;
    }
  }
  if (this.originalSelectionState.selectionManagerOperationState && this.textFlow.interactionManager) {
    this.textFlow.normalize();
    this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__postOpSelectionState = new org.apache.royale.textLayout.edit.SelectionState(this.textFlow, this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement.getAbsoluteStart(), this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement.getAbsoluteStart() + this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement.textLength);
    this.textFlow.interactionManager.setSelectionState(this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__postOpSelectionState);
  }
  return true;
};


/** @asprivate 
 * @export
 * @override
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.undo = function() {
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList.undo();
  return this.originalSelectionState;
};


/** @asprivate 
 * @export
 * @override
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.redo = function() {
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__mementoList.redo();
  return this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__postOpSelectionState;
};


org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.get__parent = function() {
  return this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeParentMarker ? this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeParentMarker.findElement(this.originalSelectionState.textFlow) : null;
};


org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.set__parent = function(value) {
  if (!value) {
    var /** @type {number} */ begPos = this.absoluteStart;
    var /** @type {number} */ endPos = this.absoluteEnd;
    var /** @type {org.apache.royale.textLayout.elements.IParagraphElement} */ para = this.textFlow.findLeaf(begPos).getParagraph();
    var /** @type {number} */ paraStart = para.getAbsoluteStart();
    if (begPos < paraStart + para.textLength - 1) {
      if (endPos >= paraStart + para.textLength - 1)
        endPos = (paraStart + para.textLength) >> 0;
      value = para;
      for (;;) {
        var /** @type {number} */ begChildIdx = value.findChildIndexAtPosition(begPos);
        var /** @type {org.apache.royale.textLayout.elements.IFlowGroupElement} */ elem = value.getChildAt(begChildIdx);
        if (elem == null)
          break;
        begPos -= elem.parentRelativeStart;
        endPos -= elem.parentRelativeStart;
        if (endPos > elem.textLength)
          break;
        value = elem;
      }
    }
  }
  else if (!org.apache.royale.utils.Language.is(value, org.apache.royale.textLayout.elements.ISubParagraphGroupElementBase) || !org.apache.royale.utils.Language.is(value, org.apache.royale.textLayout.elements.IParagraphElement))
    value = null;
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeParentMarker = value ? new org.apache.royale.textLayout.edit.ElementMark(value, 0) : null;
};


org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.get__format = function() {
  return this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__format;
};


org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.set__format = function(value) {
  this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__format = value;
};


org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.get__newSubParagraphGroupElement = function() {
  return this.org_apache_royale_textLayout_operations_CreateSubParagraphGroupOperation__spgeElement;
};


Object.defineProperties(org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype, /** @lends {org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype} */ {
/**
  * @export
  * @type {org.apache.royale.textLayout.elements.IFlowGroupElement} */
parent: {
get: org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.get__parent,
set: org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.set__parent},
/**
  * @export
  * @type {org.apache.royale.textLayout.formats.ITextLayoutFormat} */
format: {
get: org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.get__format,
set: org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.set__format},
/**
  * @export
  * @type {org.apache.royale.textLayout.elements.SubParagraphGroupElement} */
newSubParagraphGroupElement: {
get: org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.get__newSubParagraphGroupElement}}
);


/**
 * Metadata
 *
 * @type {Object.<string, Array.<Object>>}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.ROYALE_CLASS_INFO = { names: [{ name: 'CreateSubParagraphGroupOperation', qName: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation', kind: 'class' }] };



/**
 * Reflection
 *
 * @return {Object.<string, Function>}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.ROYALE_REFLECTION_INFO = function () {
  return {
    accessors: function () {
      return {
        'parent': { type: 'org.apache.royale.textLayout.elements.IFlowGroupElement', access: 'readwrite', declaredBy: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation'},
        'format': { type: 'org.apache.royale.textLayout.formats.ITextLayoutFormat', access: 'readwrite', declaredBy: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation'},
        'newSubParagraphGroupElement': { type: 'org.apache.royale.textLayout.elements.SubParagraphGroupElement', access: 'readonly', declaredBy: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation'}
      };
    },
    methods: function () {
      return {
        'CreateSubParagraphGroupOperation': { type: '', declaredBy: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation', parameters: function () { return [ 'org.apache.royale.textLayout.edit.SelectionState', false ,'org.apache.royale.textLayout.elements.IFlowGroupElement', true ,'org.apache.royale.textLayout.formats.ITextLayoutFormat', true ]; }},
        'doOperation': { type: 'Boolean', declaredBy: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation'},
        'undo': { type: 'org.apache.royale.textLayout.edit.SelectionState', declaredBy: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation'},
        'redo': { type: 'org.apache.royale.textLayout.edit.SelectionState', declaredBy: 'org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation'}
      };
    }
  };
};
/**
 * @const
 * @type {number}
 */
org.apache.royale.textLayout.operations.CreateSubParagraphGroupOperation.prototype.ROYALE_COMPILE_FLAGS = 10;
